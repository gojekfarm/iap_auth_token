require 'spec_helper'

RSpec.describe IapAuthToken::Token do
	it 'should call google oauth api to generate the bearer token' do
		requestURI = IapAuthToken::Token::TokenURI
		grant_type = IapAuthToken::Token::JWTBearerType
		assertion = "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiI3NjEzMjY3OTgwNjktcjVtbGpsbG4xcmQ0bHJiaGc3NWVmZ2lncDM2bTc4ajVAZGV2ZWxvcGVyLmdzZXJ2aWNlYWNjb3VudC5jb20iLCJzY29wZSI6Imh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL2F1dGgvcHJlZGljdGlvbiIsImF1ZCI6Imh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL29hdXRoMi92NC90b2tlbiIsImV4cCI6MTMyODU1NDM4NSwiaWF0IjoxMzI4NTUwNzg1fQ.UFUt59SUM2_AW4cRU8Y0BYVQsNTo4n7AFsNrqOpYiICDu37vVt-tw38UKzjmUKtcRsLLjrR3gFW3dNDMx_pL9DVjgVHDdYirtrCekUHOYoa1CMR66nxep5q5cBQ4y4u2kIgSvChCTc9pmLLNoIem-ruCecAJYgI9Ks7pTnW1gkOKs0x3YpiLpzplVHAkkHztaXiJdtpBcY1OXyo6jTQCa3Lk2Q3va1dPkh_d--GU2M5flgd8xNBPYw4vxyt0mP59XZlHMpztZt0soSgObf7G3GXArreF_6tpbFsS3z2t5zkEiHuWJXpzcYr5zWTRPDEHsejeBSG8EgpLDce2380ROQ"
		stub_request(:post, requestURI).
			with(body: {"grant_type"=> grant_type, "assertion" => assertion},
			     headers: {'Content-Type'=> "application/x-www-form-urlencoded"}).
			to_return(status: 200, body: JSON.dump({"id_token": "eyJhbGciOiJSUzI1NiIsImtpZCI6IjVmZTJkNTQxYTQyODJiN2FlMzYyOGZhMDc0ZGQ4YmVhNmRhNWIxOWIiLCJ0eXAiOiJKV1QifQ.eyJpc3MiOiJodHRwczovL2FjY291bnRzLmdvb2dsZS5jb20iLCJhdWQiOiI4MjQxNzg5NDA2OTItNjVvOWYyamtydG02bWRrbWIxZDBxbGt1MGI0NWRkOTkuYXBwcy5nb29nbGV1c2VyY29udGVudC5jb20iLCJhenAiOiJraW5nc2x5LWlhcEBzeXN0ZW1zLTAwMDEuaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iLCJzdWIiOiIxMTI3MDk4ODI0NzQzMTgyMzMwNTIiLCJlbWFpbCI6ImtpbmdzbHktaWFwQHN5c3RlbXMtMDAwMS5pYW0uZ3NlcnZpY2VhY2NvdW50LmNvbSIsImVtYWlsX3ZlcmlmaWVkIjp0cnVlLCJpYXQiOjE1NTMwNTE5NjQsImV4cCI6MTU1MzA1NTU2NH0.LeTvopOu85SunNRWqIOCYunQ5M-e8ASBVf2Ps8S-IJ0HITVo17zoDTcalUOSivsu31Z5gstxh3Ya_51ALAE8D6DwmcOHzyxx6L9gkOaUuid-w_51pC_Bdbg0Jt3qpup3RtWSNOOk-58rKoarM9TURAKULEFNXaH2cgx8mSsxrx1vnKdbvWi7-8TGw-SviYPup3rdMsi6FeHmw0_iUgiw6KQ2wiSPXa88GV33P5Wmwa8Ro-SXKeRm6usiWqbOzQDKEec4gPzou-pOP8Vslt6RUFc5LQiFnkhYgJKinJuqUKBSougntrPrhB3aiG_eV666DcYKbBAQDki3D8-1IAARtw"}))
		response_jwt = IapAuthToken::Token.generate_bearer_token( assertion )

		expect(response_jwt).to eq("eyJhbGciOiJSUzI1NiIsImtpZCI6IjVmZTJkNTQxYTQyODJiN2FlMzYyOGZhMDc0ZGQ4YmVhNmRhNWIxOWIiLCJ0eXAiOiJKV1QifQ.eyJpc3MiOiJodHRwczovL2FjY291bnRzLmdvb2dsZS5jb20iLCJhdWQiOiI4MjQxNzg5NDA2OTItNjVvOWYyamtydG02bWRrbWIxZDBxbGt1MGI0NWRkOTkuYXBwcy5nb29nbGV1c2VyY29udGVudC5jb20iLCJhenAiOiJraW5nc2x5LWlhcEBzeXN0ZW1zLTAwMDEuaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iLCJzdWIiOiIxMTI3MDk4ODI0NzQzMTgyMzMwNTIiLCJlbWFpbCI6ImtpbmdzbHktaWFwQHN5c3RlbXMtMDAwMS5pYW0uZ3NlcnZpY2VhY2NvdW50LmNvbSIsImVtYWlsX3ZlcmlmaWVkIjp0cnVlLCJpYXQiOjE1NTMwNTE5NjQsImV4cCI6MTU1MzA1NTU2NH0.LeTvopOu85SunNRWqIOCYunQ5M-e8ASBVf2Ps8S-IJ0HITVo17zoDTcalUOSivsu31Z5gstxh3Ya_51ALAE8D6DwmcOHzyxx6L9gkOaUuid-w_51pC_Bdbg0Jt3qpup3RtWSNOOk-58rKoarM9TURAKULEFNXaH2cgx8mSsxrx1vnKdbvWi7-8TGw-SviYPup3rdMsi6FeHmw0_iUgiw6KQ2wiSPXa88GV33P5Wmwa8Ro-SXKeRm6usiWqbOzQDKEec4gPzou-pOP8Vslt6RUFc5LQiFnkhYgJKinJuqUKBSougntrPrhB3aiG_eV666DcYKbBAQDki3D8-1IAARtw")
	end

	it 'should call google oauth api and fail if assertion is invalid JWT signature' do
		requestURI = IapAuthToken::Token::TokenURI
		grant_type = IapAuthToken::Token::JWTBearerType
		assertion = "eyJhbGciOiJSUzI1NiJ9.eyJpc3MiOiJraW5nc2x5LWlhcEBzeXN0ZW1zLTAwMDEuaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iLCJhdWQiOiJodHRwczovL3d3dy5nb29nbGVhcGlzLmNvbS9vYXV0aDIvdjQvdG9rZW4iLCJleHAiOjE1NTMwNTU1MzEsImlhdCI6MTU1MzA1MTkzMSwidGFyZ2V0X2F1ZGllbmNlIjoiODI0MTc4OTQwNjkyLTY1bzlmMmprcnRtNm1ka21iMWQwcWxrdTBiNDVkZDk5LmFwcHMuZ29vZ2xldXNlcmNvbnRlbnQuY29tIn0.Q0RAGURpqZZWXGsXXeDmMQ-tyChFpL4KBnsStM0VuF9uRUd81Lk2UqHJTU6uJ3Y8NJQ7TqXe3q15iDb91vWWgKHSb85IPkI6OmicDw9YMA60emPNFoeW5gk2elKTU-ZXtxgrSWGKRoUrWo8og0VdMhHecTKEZiXaOmKlXZuFKO3oS2sPey4oLqE4tboYTYqk1vmacNFbqoXj8blPsr5sGAbxL8rEYl9Qb3CvJwjYdvdhBgZG35wwmyhoPoIvcaaEMziiz4GtPo9eMYzI7El1jiMzCO3AXPJ0xVJes7sQseoLp00HkxdtZbXfwyTwtmvY4W4TKNvUEOGpYHasdfdffdg"
		stub_request(:post, requestURI).
			with(body: {"grant_type"=> grant_type, "assertion" => assertion},
			     headers: {'Content-Type'=> "application/x-www-form-urlencoded"}).
			to_return(status: 400, body: JSON.dump({"error": "invalid_grant", "error_description": "Invalid JWT Signature."}))

 		expect { IapAuthToken::Token.generate_bearer_token( assertion ) }.to raise_error("Request failed with error: invalid_grant and description: Invalid JWT Signature.")
	end
end
